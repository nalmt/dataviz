<!DOCTYPE html>
<head>
    <title>Overshoot Day Comparision</title>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
    </style>
</head>

<body>

  <div id="selectContainer">
  </div>

  <button type="button" onclick="addCountryToPlot()">Add to plot</button>
  <br> <br>
  <ul id="countryList"></ul>
  <br> <br>
  <svg id="chart" width="850" height="410"></svg>

  <script>

    let selectedCountry = "";
    let selectedCountries = {};
    // https://stackoverflow.com/questions/32177431/d3js-map-selectable-country-list

    // Create a div for the Input and its label
    d3.select('#selectContainer').append('div').attr('id','selection');
    d3.select("#selection").append('div').attr("class",'labelSelect').html("Select a Country :");


    // Create the Select Input
    const countrySelect  = d3.select("#selection")
            .append("select")
            .attr('id','countrySelect')
            .on("change", changeCountry);


    let dataToDisplay = new Map();

    d3.csv("datasets/nfa_2019.csv").then(function(data) {
      let countries_brut = []
      for (let i = 0; i < data.length; i++) {
        countries_brut.push(data[i].country)
      }

      let uniqueCountriesSet = new Set(countries_brut)

      let uniqueCountriesArray = []
      for (let item of uniqueCountriesSet.values()) {
        uniqueCountriesArray.push(item)
        dataToDisplay[item] = {}
      }

      uniqueCountriesArray.sort()

      const countryOptions = countrySelect.selectAll('option')
            .data(uniqueCountriesArray)
            .enter()
            .append("option")
            .attr("selected", function(d){
                if (d.localeCompare('World') == 0) {
                  selectedCountry = d;
                  return true;
                }
            })
            .text(function(d) { return d; });
            
    });
    

    function changeCountry() {
      // Grab currently selected option
      let s = d3.select(this);
      let i = s.property("selectedIndex");
      let d = s.selectAll('option').data()[i];
      selectedCountry = d;

      // console.log(d);
      // Call function that shows Tooltip for specific city 'd'
    } 
    
    countryId = 0;
    function addCountryToPlot() {

      if (findInMap(selectedCountries, selectedCountry)) {

      } else {
        //console.log(selectedCountry);
        selectedCountries.set(countryId, selectedCountry);
        console.log(selectedCountries);

        const ul = document.getElementById("countryList");

        const li = document.createElement("li");
        li.setAttribute('id','selectedCountry_'+countryId);
        li.appendChild(document.createTextNode(selectedCountry));
        
        const but = document.createElement("button");
        but.setAttribute('type', 'button');

        let string = 'removeCountry(selectedCountry_'+countryId+')';
        
        but.setAttribute('onclick', string);
        but.innerHTML = "remove"
        li.appendChild(but);

        ul.appendChild(li);

        countryId += 1;
      }
      
    }

    function removeCountry(li) {
      ind = parseInt(li.getAttribute('id').split('_')[1], 10);
      console.log(ind);

      selectedCountries.delete(ind);

      console.log(selectedCountries);

      li.parentNode.removeChild(li);
    }

    const findInMap = (map, val) => {
      for (let v of map.values()) {
        if (v === val) { 
          return true; 
        }
      }  
      return false;
    }


    // CHART


    d3.csv("datasets/nfa_2019.csv").then(function(data) {

      let countries_brut = []
      for (let i = 0; i < data.length; i++) {
        countries_brut.push(data[i].country)
      }

      let uniqueCountriesSet = new Set(countries_brut)

      let uniqueCountriesArray = []
      for (let item of uniqueCountriesSet.values()) {
        uniqueCountriesArray.push(item)
        dataToDisplay[item] = {}
      }

      // Real data
      let current_year = 0
      let current_country = undefined
      let biocap = undefined
      let efcons = undefined

      for (let i = 0; i < data.length; i++) {
        if (current_country == undefined){
          current_country = data[i].country
        }

        if (data[i].country == current_country) {
          if (data[i].year > current_year) {
            current_year = data[i].year
          }
        } else {
          current_year = data[i].year
          current_country = data[i].country
        }
        
        if (data[i].year == current_year && data[i].record == "BiocapTotGHA") {
          biocap = data[i].total
        } else if (data[i].year == current_year && data[i].record == "EFConsTotGHA") {
          efcons = data[i].total
          dataToDisplay[current_country][current_year] = (biocap/efcons)*365
        }

      }

      console.log(Object.keys(dataToDisplay["Morocco"]))

    });

  </script>
</body>